# SQLite CRUD API

This project is a lightweight REST API for manipulating SQLite databases.  

---

## Why This Exists

I made this API for several reasons:  

1. **Proof of Concept for SQLite manipulation**  
   I wanted to experiment with direct SQLite database manipulation. This API was my testbed, using a language I’m most comfortable with. Instead of building a UI right away, I used Postman to interact with the API and manage data.

2. **Future Work / Electron App**  
   My eventual goal is to build a local Electron app for managing SQLite files. These API functions will map cleanly to the backend of that app and provide a clear structure for what the frontend needs.

3. **Potential Web Use**  
   While a web app wasn’t the original intent, this API could also serve as the backend for one. Anyone else is welcome to use it for a simple, file-based SQLite manipulation API.

4. **Frontend Layout**  
   By designing this API, I’ve effectively created the blueprint for the Electron frontend. The API clarifies what functions are needed at each level of the stack.

---

## Running the Project

To run the API locally in the terminal, use:

```bash
npm run dev
```

This launches the development server and watches for TypeScript changes.

---

## API Overview

The API provides **CRUD operations** at 4 distinct layers:

- **Databases**: Create, list, rename, or delete SQLite files.
- **Tables**: Create, copy, search, paginate, sort (including random order), edit, and delete tables within a database.
- **Columns**: Define and manage the structure of a table, using metadata for types, tags, and rules.
- **Rows**: Insert, edit, patch, or delete actual data inside tables.

Additionally, there is a rigid structure to the databases created by this API. Six columns which cannot be deleted, renamed, or moved are:  

- `id`  
- `title`  
- `content`  
- `date_created`  
- `date_modified`  
- `hidden`  

The only two that are necessary to use are `id` and `title`, as `id` is autogenerated and `title` cannot be left blank. You could theoretically hide each of these columns and never use them.

---

## Column Types

All user-defined columns must specify one of the following types:

```
string
integer
float
boolean
rating          // integer 0–5
advanced_rating // float 0–10
date            // unix timestamp (ms)
single_select   // choose one value from a predefined list
multi_select    // choose multiple values from a predefined list
rich_text       // markdown or similar
link            // JSON string with {displayName: string, url: string}
custom          // accepts rule metadata for regex-based validation
```

Validation occurs at the API layer to enforce these rules.

---

## Endpoints

### Database Endpoints

#### Create a Database
```http
POST {{baseURL}}/api/database
{
  "name": "test"
}
```

#### Get a Database (metadata + tables, no rows)
```http
GET {{baseURL}}/api/database/:dbId
```

#### List All Databases
```http
GET {{baseURL}}/api/database
```

#### Rename a Database
```http
PUT {{baseURL}}/api/database/:dbId
{
  "newName": "test edited"
}
```

#### Delete a Database
```http
DELETE {{baseURL}}/api/database/:dbId
```

---

### Table Endpoints

#### Create a Table
```http
POST {{baseURL}}/api/database/:dbId/table
{
  "tableName": "my_table"
}
```

#### Copy a Table Between Databases
```http
POST {{baseURL}}/api/database/:sourceDbId/table/:tableName/copy
{
  "targetDbId": "target_database",
  "newTableName": "optional_new_name"
}
```

Copies a table and its metadata to another database or within the same one.  
Table names are protected. Duplicates within the same database are not allowed.

#### Get Rows from a Table (supports pagination, search, sorting, hidden filter)
```http
GET {{baseURL}}/api/database/:dbId/table/:tableName?offset=0&limit=10&q=test and hidden:false&s=count:asc
```

#### Random Sort Example
```http
GET {{baseURL}}/api/database/:dbId/table/:tableName?s=rand
```
When `s=rand`, results are returned in a randomized order.

#### Rename a Table
```http
PATCH {{baseURL}}/api/database/:dbId/table/:tableName
{
  "newName": "renamed_table"
}
```

#### Change Table Visibility
```http
PATCH {{baseURL}}/api/database/:dbId/table/:tableName/visibility
{
  "hidden": true
}
```

#### Delete a Table
```http
DELETE {{baseURL}}/api/database/:dbId/table/:tableName
```

---

### Column Endpoints

#### Create a Column
```http
POST {{baseURL}}/api/database/:dbId/table/:tableName/column
{
  "name": "skill",
  "type": "multi_select",
  "hidden": false
}
```

#### Get All Columns in a Table
```http
GET {{baseURL}}/api/database/:dbId/table/:tableName/columns
```

#### Get a Single Column
```http
GET {{baseURL}}/api/database/:dbId/table/:tableName/column/:columnName
```

#### Set a Column Rule (for custom types)
```http
PATCH {{baseURL}}/api/database/:dbId/table/:tableName/column/:columnName/rule
{
  "rule": "^[A-Za-z0-9_]+$"
}
```
Allows regex-based restrictions for data validation on custom type columns.

#### Rename or Change Column Type
```http
PATCH {{baseURL}}/api/database/:dbId/table/:tableName/column/:columnName
{
  "newName": "skill_level",
  "newType": "string"
}
```

#### Change Column Visibility
```http
PATCH {{baseURL}}/api/database/:dbId/table/:tableName/column/:columnName/visibility
{
  "hidden": true
}
```

#### Swap Column Index
```http
PATCH {{baseURL}}/api/database/:dbId/table/:tableName/column/:columnName/swap
{
  "targetIndex": 6
}
```

#### Move Column Index
```http
PATCH {{baseURL}}/api/database/:dbId/table/:tableName/column/:columnName/move
{
  "newIndex": 6
}
```

#### Register a Tag for a Column
```http
POST {{baseURL}}/api/database/:dbId/table/:tableName/column/:columnName/tag
{
  "name": "novice",
  "description": "Entry-level"
}
```

#### Unregister a Tag
```http
DELETE {{baseURL}}/api/database/:dbId/table/:tableName/column/:columnName/tag
{
  "tag": "novice"
}
```

#### Delete a Column
```http
DELETE {{baseURL}}/api/database/:dbId/table/:tableName/column/:columnName
```

---

### Row Endpoints

#### Create a Row
```http
POST {{baseURL}}/api/database/:dbId/table/:tableName/row
{
  "title": "New Row",
  "content": "Some content"
}
```

#### Get a Single Row
```http
GET {{baseURL}}/api/database/:dbId/table/:tableName/row/:rowId
```

#### Update Row Visibility
```http
PATCH {{baseURL}}/api/database/:dbId/table/:tableName/row/:rowId/visibility
{
  "hidden": true
}
```

#### Patch Row Data
```http
PATCH {{baseURL}}/api/database/:dbId/table/:tableName/row/:rowId
{
  "content": "Edited content"
}
```

#### Delete a Row
```http
DELETE {{baseURL}}/api/database/:dbId/table/:tableName/row/:rowId
```

---

### Backup Endpoints

#### Create a Backup
```http
POST {{baseURL}}/api/backup/:dbId
```
Creates a full backup of the specified database, including metadata.  
The backup is stored in the server’s `backups` directory with a unique timestamp.

#### List All Backups
```http
GET {{baseURL}}/api/backups/retrieve
```
Retrieves a list of all existing database backups with their timestamps and IDs.

#### Recover a Backup
```http
POST {{baseURL}}/api/recover/:backupName
```
Restores a backup as a new database in the main database directory.  
The restored database will be renamed using the pattern `restored_{originalName}_{timestamp}`.

#### Delete a Backup
```http
DELETE {{baseURL}}/api/backup/:backupName
```
Deletes the specified backup and its metadata from the `backups` directory.

## Complex Searching and Pagination

The API supports advanced querying and sorting for table rows. This allows fine-grained control over which rows are returned and in what order.

### `q` — Query (Search)
- Uses **Lucene-style syntax** with support for:
  - **Parentheses `()`** for grouping and order of operations.
  - **`and`**: Both conditions must be true.
  - **`or`**: Either condition can be true.
  - **`!`**: Negation operator (exclude matches).
- **Column targeting**:
  - Use the **normalized column name**: `title:test`
  - Or use **column index**: `i1:test`
  - Example: `title:test` and `i1:test` are identical.
- **Default column**: `title`.  
  - Example: `test` is the same as `title:test`.
- **Default operator**: `and`.  
  - Example: `test case` → `title:test AND title:case`
- **Exact phrase search**: Wrap in quotes.
  - Example: `i1:"test case"` matches only rows with the exact phrase `"test case"`.

#### Examples:
- `q=alpha and beta` → Matches rows where both "alpha" and "beta" are in the title.
- `q=(alpha or beta) and !gamma` → Matches rows with "alpha" or "beta", but excludes those containing "gamma".
- `q=i2:"gamma test"` → Matches rows where column at index `2` contains the exact phrase "gamma test".

---

### `s` — Sorting
Sorting uses a similar syntax to queries, but specifies a column and an order.

- Syntax: `s=column:asc` or `s=column:desc`
- To randomize order, use `s=rand`
- Columns can be targeted by name or index.
  - Example: `s=i2:asc` or `s=title:desc`

#### Examples:
- `s=title:asc` → Sort rows alphabetically by title.
- `s=i3:desc` → Sort rows descending by the column at index `3`.
- `s=rand` → Shuffle results randomly.

---

### Pagination

- **`limit`**: Maximum number of rows to return.  
  - Example: `limit=10`
- **`offset`**: Starting row for pagination.  
  - Example: `offset=10`

#### Example Combined Request:
```http
GET {{baseURL}}/api/database/:dbId/table/:tableName?q=(alpha or beta)&s=i2:asc&limit=10&offset=10
```

This example:
- Finds rows where title contains alpha or beta.
- Sorts results ascending by column index 2.
- Skips the first 10 rows.
- Returns the next 10 rows.

---

## Notes

- Six **system columns** (`id`, `title`, `content`, `date_created`, `date_modified`, `hidden`) cannot be deleted, renamed, moved, or retyped.  
- All user-defined columns must declare a valid type (see column types above).
- Tags require registration before being assigned to rows.
- Custom columns can define regex validation rules using the rule endpoint.
- Rich text is stored as plain strings and must be formatted and handled on the frontend.
